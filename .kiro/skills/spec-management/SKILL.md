---
name: spec-management
description: >-
  Spec・タスク管理のワークフローとルール。Spec の作成、要件番号の採番、tasks.md の書き方、
  タスク順序の原則を扱う。「Spec を作って」「要件を書いて」「tasks.md」「設計ドキュメント」と言われたときに使う。
---

# Spec・タスク管理ルール

## ワークフロー

1. **Issue 作成** → Issue を作成（アイデア段階）
2. **Spec 作成** → 着手決定後、`.kiro/specs/` に Spec を作成
3. **実装** → Spec のタスクに従って実装

ドラフトは Issue で管理する。Spec は着手決定後のみ作成。

## 禁止ファイル

- `.config.kiro` を生成しないこと（spec フォルダ内を含むすべての場所）

## Spec フォルダ構成

| フォルダ | 用途 | 日付プレフィックス |
|---------|------|-------------------|
| `.kiro/specs/` | 着手済み | **必須** `YYYYMMDD-NNN-` |

## 日付プレフィックス

- **形式**: `YYYYMMDD-NNN-{feature-name}` （例: `20260117-001-feature`）
- **NNN**: 同日内の枝番（001, 002, ...）
- **基準日**: Git コミット日

## 要件番号

**形式**: `{PREFIX}-{要件番号}.{受け入れ基準番号}`

- Spec 名の頭文字から 3-4 文字の略語を作成
- 例: `token-marketplace` → `TMP-1.1`

**重複チェック**:
```bash
grep -h "^### 要件" .kiro/specs/*/requirements.md | sed 's/### 要件 \([A-Z]*\).*/\1/' | sort -u
```

## tasks.md ルール

### 構造

`## タスク` 内では `###` 見出し禁止（Kiro パーサーの制約）:

```markdown
## タスク

- [ ] 1. セットアップ
  - [ ] 1.1 プロジェクト作成
  - _Requirements: XXX-1.1_
```

### 禁止表現

| 禁止 | 理由 |
|-----|------|
| 「将来的に」「後で」「今後」 | 時期が曖昧 |
| 「必要に応じて」「オプションで」 | やるか不明確 |
| 「TBD」「検討する」 | 未決定が残る |

### TODO コメントの使用

**同一 spec 内で後続タスクとして実装予定の機能には `// TODO:` コメントを許可する。**

```
// TODO: ADH-2.3 で実装予定
```

- TODO コメントには対応する要件番号（例: `ADH-2.3`）を記載すること
- spec 完了時に全 TODO が解消されていることを確認

### 振り返りチェックポイント

**各実装タスクの末尾に「誠実実装チェック」サブタスクを必ず追加する。**

仮実装・スタブ・ハードコード等の誤魔化しが混入しやすいため、タスク完了前に自己点検を行う。

```markdown
- [ ] N.X 誠実実装チェック: 仮実装・スタブ・ハードコード値・TODO 放置・テストスキップがないか確認する
```

ルール:
- 実装系タスク（コード変更を伴うもの）には必ず付与する
- チェックポイントタスク・テスト修正タスクには不要
- 確認観点: ハードコード値, 空の関数体, 要件の部分実装

### 完全性チェック

1. requirements.md の**全受け入れ基準**がタスクに紐付いている
2. design.md の**全コンポーネント**がタスク化されている
3. 各タスクに `_Requirements: XXX-N.M_` 記載

**カバレッジ検証**:
```bash
comm -23 <(grep -oE '[A-Z]+-[0-9]+\.[0-9]+' requirements.md | sort -u) \
         <(grep -oE '[A-Z]+-[0-9]+\.[0-9]+' tasks.md | sort -u)
```

### タスク粒度

1タスク = 1〜4時間 / 1 PR / 明確な完了条件

### タスク順序の原則

**共通基盤・ガードレールを先に実装する。**

| 優先度 | タスク種別 | 例 |
|--------|-----------|-----|
| 1 | スキーマ定義 | JSON Schema、型定義 |
| 2 | 共通インフラ | エンドポイント、共有モジュール |
| 3 | コア機能 | ビジネスロジック |
| 4 | UI / 統合 | コンポーネント、画面統合 |

**アンチパターン**:
```
❌ Phase 1: UI 基盤 → Phase 2: 機能実装 → Phase 3: スキーマ定義
✅ Phase 1: スキーマ定義 → Phase 2: 共通基盤 → Phase 3: 機能実装 → Phase 4: UI 統合
```
